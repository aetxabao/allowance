# Ejercicios productor-consumidor: allowance 

El contexto de estos ejercicios es la simulación de la asignación semanal (paga/allowance) a hijos e hijas (children) por parte de sus padres, madres o responsables (parents). En principio la paga de los parent es constante y para simular la asignación semanal hacen un ingreso (Insert) de la cantidad fija y luego duermen (Sleep) hasta la semana siguiente. Para simular las acciones de un año de un parent, se ejecutará un bucle de 52 semanas en las cuales se harán esas dos acciones (Insert y Sleep), ingresando la cantidad fija definida y durmiendo 7 ms para simular que cada día es un milisegundo y que hasta la semana siguiente no hace nada. La cuenta (account) en la que se ingresa (Insert) y retira (Remove) las cantidades (amount) indicadas se crea con una cantidad inicial y va a tener un resultado (Balance). Como las operaciones sobre la cuenta tienen que estar sincronizadas se utiliza el bloqueo (lock) de un objeto (token) para asegurar el acceso controlado. Se puede tomar el código base y comentar estas sentencias para ver que los resultados son inesperados. Respecto de los children, se simulan distintas circunstancias. Inicialmente sólo hay un child que retira (Remove) semanalmente la misma cantidad que ingresa el parent, con lo que al final el saldo es cero. El código que ejecuta inicialmente el child es igual al del parent con la diferencia de que hacer Remove en vez de Insert y luego Sleep en un bucle.

Partiendo del código base se plantean distintos escenarios que se van complicando en cada paso.

1. Simular que en la cuenta que inicialmente está vacía (0), un parent ingresa semanalmente 5 y un child retira una cantidad aleatoria entre 3 y 8 unidades semanalmente. Indicar el saldo final de esa simulación. A continuación suponer para una nueva simulación que se ejecuta en el mismo Main que el saldo de la cuenta inicialmente es el valor absoluto del saldo final de la anterior simulación y el resto de datos son los mismos. Mostrar el saldo final de esta nueva ejecución.

2. Simular el caso de 3 consumidores (child) que semanalmente retiran una cantidad aleatoria de entre 3 y 8 unidades. Mostrar cuánto ha gastado cada child, el saldo final de la cuenta y cuánto ha sido el importe total depositado por el parent. Comprobar con la calculadora que los depósitos totales menos lo gastado por todos los children  da como resultado el saldo final (positivo o negativo).

3. El parent ha negociado con el banco bloquear la cuenta al final de año y el límite del descubierto posible. Es decir, cuando se vaya a extraer dinero, mientras la cuenta esté abierta, si el balance menos la cantidad que se quiere retirar es menor que el límite definido (-100) se pondrá en espera y cuando sea notificado se comprobará de nuevo si la cuenta no está cerrada y cuando haya saldo suficiente se retirará esa cantidad del balance. Como puede ser que algún child se quedase bloqueado al final del año, cuando el parent termine de hacer los 52 ingresos la cuenta se cerrará, lo cual provocará que se saquen todos los hilos de la cola de espera. Cuando se haga un ingreso en la cuenta sólo se hará una notificación al primer hilo que pudiese estar en la cola de espera. Además se debe simular que con un 10% de probabilidades la cantidad aleatoria de 3 a 8 unidades que retiran los child sea multiplicada por 10. En la ejecución se podrá observar cómo algún child gasta mucho más o mucho menos que los otros. Comprobar las cuentas:
depósitos totales = gastado por todos los child + saldo final

4. En este caso se va a simular que haya 2 parents, 3 children, la cuenta inicial a 0, descubierto posible de -100,  que cada uno de los parents ingresa 10 unidades y que cada uno de los child retira semanalmente de forma aleatoria de 3 a 8 pero con una probabilidad del 10% que sea 10 veces más. Como los child se pueden quedar bloqueados si no pueden retirar la cantidad deseada, sólo esperarán 1 ms y registrarán el número de veces que les ha ocurrido estos bloqueos. Al final de la ejecución del programa se debe mostrar cuánto ingresa y retira cada uno y en el caso de los children cuántas veces ha sido bloqueado cada uno. Comprobar que la resta de lo depositado menos lo retirado es igual al saldo final y que este no es menor que -100.

5. Simular que hay tres parents, tres children y tres cuentas separadas. Cada parent y child tiene sólo una cuenta. Ejecutar el programa siendo el ingreso de cada parent de 5 unidades en cada cuenta inicialmente vacía, que el descubierto de cada cuenta posible es de -10 y que cada child retira de entre 3 a 8 unidades con una probabilidad del 10% de que sea diez veces más y que cuando son bloqueados sólo esperan en la cola de espera 1 ms. Mostrar al finalizar la ejecución la cantidad total depositada, cuánto se ha gastado y cuántas veces ha sido bloqueado cada caso de los tres.

Una posible solución de cada uno de los ejercicios se encuentra en cada una de las ramas del repositorio de GitHub.

